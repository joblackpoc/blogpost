{% extends 'base.html' %}

{% block title %}{{ post.get_og_title }} | {{ block.super }}{% endblock %}

{% block extra_head %}
<!-- SEO Meta Tags -->
<meta name="description" content="{{ post.get_meta_description }}">
{% if post.meta_keywords %}<meta name="keywords" content="{{ post.meta_keywords }}">{% endif %}
<meta name="author" content="{{ post.author.username }}">
<link rel="canonical" href="{{ request.build_absolute_uri }}">

<!-- Open Graph / Facebook -->
<meta property="og:type" content="article">
<meta property="og:url" content="{{ request.build_absolute_uri }}">
<meta property="og:title" content="{{ post.get_og_title }}">
<meta property="og:description" content="{{ post.get_og_description }}">
{% if post.get_og_image %}<meta property="og:image" content="{{ post.get_og_image }}">{% endif %}
<meta property="article:published_time" content="{{ post.published_at|date:'c' }}">
<meta property="article:modified_time" content="{{ post.updated_at|date:'c' }}">
<meta property="article:author" content="{{ post.author.username }}">
{% if post.category %}<meta property="article:section" content="{{ post.category.name }}">{% endif %}
{% for tag in post.tags.all %}<meta property="article:tag" content="{{ tag.name }}">{% endfor %}

<!-- Twitter Card -->
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:url" content="{{ request.build_absolute_uri }}">
<meta name="twitter:title" content="{{ post.get_og_title }}">
<meta name="twitter:description" content="{{ post.get_og_description }}">
{% if post.get_og_image %}<meta name="twitter:image" content="{{ post.get_og_image }}">{% endif %}

<!-- Schema.org JSON-LD -->
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "{{ post.title|escapejs }}",
  "description": "{{ post.get_meta_description|escapejs }}",
  "image": {% if post.get_og_image %}"{{ post.get_og_image }}"{% else %}null{% endif %},
  "author": {
    "@type": "Person",
    "name": "{{ post.author.username }}"
  },
  "publisher": {
    "@type": "Organization",
    "name": "{{ request.site.name|default:'Blog' }}"
  },
  "datePublished": "{{ post.published_at|date:'c' }}",
  "dateModified": "{{ post.updated_at|date:'c' }}",
  "wordCount": {{ post.content|wordcount }},
  "keywords": "{{ post.get_hashtags|escapejs }}"
}
</script>
{% endblock %}

{% block content %}
<article>
<h1>{{ post.title }}</h1>
<p class="text-muted">By {{ post.author.username }} | {{ post.published_at|date:"F d, Y" }} | Views: {{ post.views }}</p>
{% if post.featured_image %}<img src="{{ post.featured_image.url }}" class="img-fluid mb-3">{% endif %}

{% if post.video_link %}
<div class="video-container mb-3">
    {% with embed_url=post.get_youtube_embed_url %}
        {% if embed_url %}
        <div class="ratio ratio-16x9">
            <iframe src="{{ embed_url }}"
                    title="YouTube video player"
                    frameborder="0"
                    allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
                    allowfullscreen>
            </iframe>
        </div>
        {% else %}
        <div class="alert alert-warning">
            <strong>Video Link:</strong> <a href="{{ post.video_link }}" target="_blank" rel="noopener noreferrer">{{ post.video_link }}</a>
        </div>
        {% endif %}
    {% endwith %}
</div>
{% endif %}

{% if post.link_url %}
<div class="link-preview-container mb-3">
    <a href="{{ post.link_url }}" target="_blank" rel="noopener noreferrer" class="text-decoration-none">
        <div class="card border">
            {% if post.link_image %}
            <img src="{{ post.link_image }}" class="card-img-top" alt="{{ post.link_title }}" style="width: 100%; height: auto; object-fit: contain;">
            {% endif %}
            {% if post.link_video %}
            <div class="ratio ratio-16x9">
                <video controls poster="{{ post.link_image }}">
                    <source src="{{ post.link_video }}" type="video/mp4">
                    Your browser does not support the video tag.
                </video>
            </div>
            {% endif %}
            <div class="card-body">
                {% if post.link_title %}
                <h5 class="card-title text-dark">{{ post.link_title }}</h5>
                {% endif %}
                {% if post.link_description %}
                <p class="card-text text-muted">{{ post.link_description|truncatewords:30 }}</p>
                {% endif %}
                <small class="text-muted">{{ post.link_url|truncatechars:50 }}</small>
            </div>
        </div>
    </a>
</div>
{% endif %}

<div>{{ post.content|safe }}</div>

<!-- Tags/Hashtags Display -->
{% if post.tags.all %}
<div class="tags-container my-3">
    {% for tag in post.tags.all %}
    <a href="{% url 'blog:tag_posts' tag.slug %}" class="badge bg-primary text-decoration-none me-1 mb-1">#{{ tag.name }}</a>
    {% endfor %}
</div>
{% endif %}

<!-- Share Buttons -->
<div class="share-buttons my-4 p-3 bg-light rounded">
    <h5 class="mb-3">Share this post:</h5>
    <div class="d-flex flex-wrap gap-2">
        <!-- Facebook Share -->
        <a href="https://www.facebook.com/sharer/sharer.php?u={{ request.build_absolute_uri|urlencode }}"
           target="_blank"
           rel="noopener noreferrer"
           class="btn btn-primary btn-sm"
           title="Share on Facebook">
            <svg width="16" height="16" fill="currentColor" class="bi bi-facebook" viewBox="0 0 16 16">
                <path d="M16 8.049c0-4.446-3.582-8.05-8-8.05C3.58 0-.002 3.603-.002 8.05c0 4.017 2.926 7.347 6.75 7.951v-5.625h-2.03V8.05H6.75V6.275c0-2.017 1.195-3.131 3.022-3.131.876 0 1.791.157 1.791.157v1.98h-1.009c-.993 0-1.303.621-1.303 1.258v1.51h2.218l-.354 2.326H9.25V16c3.824-.604 6.75-3.934 6.75-7.951z"/>
            </svg>
            Facebook
        </a>

        <!-- LINE Share -->
        <a href="https://social-plugins.line.me/lineit/share?url={{ request.build_absolute_uri|urlencode }}"
           target="_blank"
           rel="noopener noreferrer"
           class="btn btn-success btn-sm"
           title="Share on LINE">
            <svg width="16" height="16" fill="currentColor" viewBox="0 0 24 24">
                <path d="M19.365 9.863c.349 0 .63.285.63.631 0 .345-.281.63-.63.63H17.61v1.125h1.755c.349 0 .63.283.63.63 0 .344-.281.629-.63.629h-2.386c-.345 0-.627-.285-.627-.629V8.108c0-.345.282-.63.63-.63h2.386c.346 0 .627.285.627.63 0 .349-.281.63-.63.63H17.61v1.125h1.755zm-3.855 3.016c0 .27-.174.51-.432.596-.064.021-.133.031-.199.031-.211 0-.391-.09-.51-.25l-2.443-3.317v2.94c0 .344-.279.629-.631.629-.346 0-.626-.285-.626-.629V8.108c0-.27.173-.51.43-.595.06-.023.136-.033.194-.033.195 0 .375.104.495.254l2.462 3.33V8.108c0-.345.282-.63.63-.63.345 0 .63.285.63.63v4.771zm-5.741 0c0 .344-.282.629-.631.629-.345 0-.627-.285-.627-.629V8.108c0-.345.282-.63.63-.63.346 0 .628.285.628.63v4.771zm-2.466.629H4.917c-.345 0-.63-.285-.63-.629V8.108c0-.345.285-.63.63-.63.348 0 .63.285.63.63v4.141h1.756c.348 0 .629.283.629.63 0 .344-.282.629-.629.629M24 10.314C24 4.943 18.615.572 12 .572S0 4.943 0 10.314c0 4.811 4.27 8.842 10.035 9.608.391.082.923.258 1.058.59.12.301.079.766.038 1.08l-.164 1.02c-.045.301-.24 1.186 1.049.645 1.291-.539 6.916-4.078 9.436-6.975C23.176 14.393 24 12.458 24 10.314"/>
            </svg>
            LINE
        </a>

        <!-- Twitter/X Share -->
        <a href="https://twitter.com/intent/tweet?url={{ request.build_absolute_uri|urlencode }}&text={{ post.title|urlencode }}"
           target="_blank"
           rel="noopener noreferrer"
           class="btn btn-dark btn-sm"
           title="Share on X (Twitter)">
            <svg width="16" height="16" fill="currentColor" viewBox="0 0 24 24">
                <path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/>
            </svg>
            X (Twitter)
        </a>

        <!-- Instagram (Opens Instagram app/web) -->
        <a href="https://www.instagram.com/"
           target="_blank"
           rel="noopener noreferrer"
           class="btn btn-sm"
           style="background: linear-gradient(45deg, #f09433 0%, #e6683c 25%, #dc2743 50%, #cc2366 75%, #bc1888 100%); color: white;"
           title="Share on Instagram"
           onclick="alert('Copy this link and share it in your Instagram story or bio:\\n\\n{{ request.build_absolute_uri }}'); return false;">
            <svg width="16" height="16" fill="currentColor" class="bi bi-instagram" viewBox="0 0 16 16">
                <path d="M8 0C5.829 0 5.556.01 4.703.048 3.85.088 3.269.222 2.76.42a3.917 3.917 0 0 0-1.417.923A3.927 3.927 0 0 0 .42 2.76C.222 3.268.087 3.85.048 4.7.01 5.555 0 5.827 0 8.001c0 2.172.01 2.444.048 3.297.04.852.174 1.433.372 1.942.205.526.478.972.923 1.417.444.445.89.719 1.416.923.51.198 1.09.333 1.942.372C5.555 15.99 5.827 16 8 16s2.444-.01 3.298-.048c.851-.04 1.434-.174 1.943-.372a3.916 3.916 0 0 0 1.416-.923c.445-.445.718-.891.923-1.417.197-.509.332-1.09.372-1.942C15.99 10.445 16 10.173 16 8s-.01-2.445-.048-3.299c-.04-.851-.175-1.433-.372-1.941a3.926 3.926 0 0 0-.923-1.417A3.911 3.911 0 0 0 13.24.42c-.51-.198-1.092-.333-1.943-.372C10.443.01 10.172 0 7.998 0h.003zm-.717 1.442h.718c2.136 0 2.389.007 3.232.046.78.035 1.204.166 1.486.275.373.145.64.319.92.599.28.28.453.546.598.92.11.281.24.705.275 1.485.039.843.047 1.096.047 3.231s-.008 2.389-.047 3.232c-.035.78-.166 1.203-.275 1.485a2.47 2.47 0 0 1-.599.919c-.28.28-.546.453-.92.598-.28.11-.704.24-1.485.276-.843.038-1.096.047-3.232.047s-2.39-.009-3.233-.047c-.78-.036-1.203-.166-1.485-.276a2.478 2.478 0 0 1-.92-.598 2.48 2.48 0 0 1-.6-.92c-.109-.281-.24-.705-.275-1.485-.038-.843-.046-1.096-.046-3.233 0-2.136.008-2.388.046-3.231.036-.78.166-1.204.276-1.486.145-.373.319-.64.599-.92.28-.28.546-.453.92-.598.282-.11.705-.24 1.485-.276.738-.034 1.024-.044 2.515-.045v.002zm4.988 1.328a.96.96 0 1 0 0 1.92.96.96 0 0 0 0-1.92zm-4.27 1.122a4.109 4.109 0 1 0 0 8.217 4.109 4.109 0 0 0 0-8.217zm0 1.441a2.667 2.667 0 1 1 0 5.334 2.667 2.667 0 0 1 0-5.334z"/>
            </svg>
            Instagram
        </a>

        <!-- Facebook Messenger -->
        <a href="https://www.facebook.com/dialog/send?link={{ request.build_absolute_uri|urlencode }}&app_id=YOUR_APP_ID&redirect_uri={{ request.build_absolute_uri|urlencode }}"
           target="_blank"
           rel="noopener noreferrer"
           class="btn btn-sm"
           style="background: linear-gradient(45deg, #00B2FF, #006AFF); color: white;"
           title="Share on Messenger">
            <svg width="16" height="16" fill="currentColor" viewBox="0 0 24 24">
                <path d="M12 0C5.373 0 0 4.975 0 11.111c0 3.498 1.744 6.614 4.469 8.654V24l4.088-2.242c1.092.3 2.246.464 3.443.464 6.627 0 12-4.974 12-11.11C24 4.975 18.627 0 12 0zm1.191 14.963l-3.055-3.26-5.963 3.26L10.732 8l3.131 3.259L19.752 8l-6.561 6.963z"/>
            </svg>
            Messenger
        </a>

        <!-- Copy Link -->
        <button type="button"
                class="btn btn-secondary btn-sm copy-link-btn"
                data-url="{{ request.build_absolute_uri }}"
                title="Copy link">
            <svg width="16" height="16" fill="currentColor" class="bi bi-link-45deg" viewBox="0 0 16 16">
                <path d="M4.715 6.542 3.343 7.914a3 3 0 1 0 4.243 4.243l1.828-1.829A3 3 0 0 0 8.586 5.5L8 6.086a1.002 1.002 0 0 0-.154.199 2 2 0 0 1 .861 3.337L6.88 11.45a2 2 0 1 1-2.83-2.83l.793-.792a4.018 4.018 0 0 1-.128-1.287z"/>
                <path d="M6.586 4.672A3 3 0 0 0 7.414 9.5l.775-.776a2 2 0 0 1-.896-3.346L9.12 3.55a2 2 0 1 1 2.83 2.83l-.793.792c.112.42.155.855.128 1.287l1.372-1.372a3 3 0 1 0-4.243-4.243L6.586 4.672z"/>
            </svg>
            Copy Link
        </button>
    </div>
</div>

<div class="my-3">
    {% if user.is_authenticated %}
    <form method="post" action="{% url 'blog:post_like' post.slug %}" class="d-inline like-form">
        {% csrf_token %}
        <button type="submit" class="btn btn-sm {% if user_has_liked %}btn-primary{% else %}btn-outline-primary{% endif %} like-btn" data-slug="{{ post.slug }}">
            <span class="like-icon">{% if user_has_liked %}&#10084;{% else %}&#9825;{% endif %}</span>
            <span class="like-text">{% if user_has_liked %}Unlike{% else %}Like{% endif %}</span>
        </button>
    </form>
    {% endif %}
    <span class="ms-2 like-count">{{ total_likes }} {% if total_likes == 1 %}like{% else %}likes{% endif %}</span>
</div>

{% if user == post.author or user.is_staff %}
<a href="{% url 'blog:post_edit' post.slug %}" class="btn btn-warning">Edit</a>
<a href="{% url 'blog:post_delete' post.slug %}" class="btn btn-danger">Delete</a>
{% endif %}
</article>
<hr>
<h3>Comments</h3>
{% if user.is_authenticated %}
<form method="post">{% csrf_token %}
{{ form.content }}
<button type="submit" class="btn btn-primary mt-2">Post Comment</button>
</form>
{% else %}<p><a href="{% url 'accounts:login' %}">Login to comment</a></p>{% endif %}
<hr>
{% for comment in comments %}
<div class="mb-3">
<strong>{{ comment.author.username }}</strong> - {{ comment.created_at|date:"M d, Y" }}
<p>{{ comment.content|safe }}</p>
{% if user == comment.author or user.is_staff %}
<a href="{% url 'blog:comment_delete' comment.pk %}" class="btn btn-sm btn-danger">Delete</a>
{% endif %}
</div>
{% endfor %}

<script>
document.addEventListener('DOMContentLoaded', function() {
    const likeForms = document.querySelectorAll('.like-form');
    likeForms.forEach(form => {
        form.addEventListener('submit', function(e) {
            e.preventDefault();
            const slug = this.querySelector('.like-btn').dataset.slug;
            const csrfToken = this.querySelector('[name=csrfmiddlewaretoken]').value;

            fetch(`/blog/post/${slug}/like/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': csrfToken,
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const btn = this.querySelector('.like-btn');
                    const icon = btn.querySelector('.like-icon');
                    const text = btn.querySelector('.like-text');
                    const countSpan = document.querySelector('.like-count');

                    if (data.liked) {
                        btn.classList.remove('btn-outline-primary');
                        btn.classList.add('btn-primary');
                        icon.innerHTML = '&#10084;';
                        text.textContent = 'Unlike';
                    } else {
                        btn.classList.remove('btn-primary');
                        btn.classList.add('btn-outline-primary');
                        icon.innerHTML = '&#9825;';
                        text.textContent = 'Like';
                    }

                    countSpan.textContent = `${data.total_likes} ${data.total_likes === 1 ? 'like' : 'likes'}`;
                }
            })
            .catch(error => console.error('Error:', error));
        });
    });
});

// Copy Link functionality
document.addEventListener('DOMContentLoaded', function() {
    const copyBtn = document.querySelector('.copy-link-btn');
    if (copyBtn) {
        copyBtn.addEventListener('click', function() {
            const url = this.dataset.url;

            // Modern browsers - Clipboard API
            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(url).then(function() {
                    // Success feedback
                    const originalHTML = copyBtn.innerHTML;
                    copyBtn.innerHTML = '<svg width="16" height="16" fill="currentColor" class="bi bi-check2" viewBox="0 0 16 16"><path d="M13.854 3.646a.5.5 0 0 1 0 .708l-7 7a.5.5 0 0 1-.708 0l-3.5-3.5a.5.5 0 1 1 .708-.708L6.5 10.293l6.646-6.647a.5.5 0 0 1 .708 0z"/></svg> Copied!';
                    copyBtn.classList.remove('btn-secondary');
                    copyBtn.classList.add('btn-success');

                    setTimeout(function() {
                        copyBtn.innerHTML = originalHTML;
                        copyBtn.classList.remove('btn-success');
                        copyBtn.classList.add('btn-secondary');
                    }, 2000);
                }).catch(function(err) {
                    alert('Failed to copy link. Please copy manually: ' + url);
                });
            } else {
                // Fallback for older browsers
                const textArea = document.createElement('textarea');
                textArea.value = url;
                textArea.style.position = 'fixed';
                textArea.style.left = '-999999px';
                document.body.appendChild(textArea);
                textArea.select();

                try {
                    document.execCommand('copy');
                    const originalHTML = copyBtn.innerHTML;
                    copyBtn.innerHTML = '<svg width="16" height="16" fill="currentColor" class="bi bi-check2" viewBox="0 0 16 16"><path d="M13.854 3.646a.5.5 0 0 1 0 .708l-7 7a.5.5 0 0 1-.708 0l-3.5-3.5a.5.5 0 1 1 .708-.708L6.5 10.293l6.646-6.647a.5.5 0 0 1 .708 0z"/></svg> Copied!';
                    copyBtn.classList.remove('btn-secondary');
                    copyBtn.classList.add('btn-success');

                    setTimeout(function() {
                        copyBtn.innerHTML = originalHTML;
                        copyBtn.classList.remove('btn-success');
                        copyBtn.classList.add('btn-secondary');
                    }, 2000);
                } catch (err) {
                    alert('Failed to copy link. Please copy manually: ' + url);
                }

                document.body.removeChild(textArea);
            }
        });
    }
});
</script>
{% endblock %}